# Story 3.1: Paper Delivery Mission

**Epic:** 3 - Integration & Missions

**Description:**
Implement the complete delivery mission that integrates navigation, person detection, and button confirmation. The robot will traverse the row of desks, detect occupied desks, deliver papers, and wait for student confirmation.

This is the first complete end-to-end mission that brings together all Phase 1 and Phase 2 components.

**Dependencies:**
- ✅ Story 1.1: Row configuration
- ✅ Story 1.2: Linear movement
- ✅ Story 1.3: Precise turns
- ✅ Story 1.4: Row traversal
- ✅ Story 1.5: Obstacle avoidance
- Story 2.1: Person detection
- Story 2.3: Button integration

**Tasks:**
1. Create a new module: `yahoo/mission/delivery.py`
2. Implement `DeliveryMission` class with:
   - `execute()` - Main mission entry point
   - `visit_desk(desk_id)` - Handle delivery at a single desk
   - Integration with all required subsystems
3. Mission workflow:
   - Start at origin
   - Load desk configuration
   - For each desk in row:
     - Navigate to desk position
     - Stop and check for person (person detector)
     - If person detected:
       - Deliver paper (mechanical action or prompt)
       - Set LED to yellow (waiting for confirmation)
       - Wait for button press (30 second timeout)
       - If button pressed:
         - Set LED to green (success)
         - Log successful delivery
       - If timeout:
         - Set LED to red (timeout)
         - Log timeout
     - If no person detected:
       - Skip desk (log as "empty")
   - Navigate back to origin
   - Report delivery summary
4. Add comprehensive logging:
   - Delivery started/completed
   - Each desk visited and outcome
   - Papers delivered count
   - Any errors or timeouts
5. Create test script: `scripts/run_delivery_mission.py`
6. Test full mission with:
   - All desks occupied
   - Mix of occupied/empty desks
   - Student confirms immediately
   - Student delays confirmation (test timeout)

**Acceptance Criteria:**
- A `yahoo/mission/delivery.py` module exists with `DeliveryMission` class
- A `scripts/run_delivery_mission.py` script successfully runs the full mission
- Robot navigates to each desk in the configured row
- Person detection correctly identifies occupied vs. empty desks
- Papers are delivered only to occupied desks
- Button confirmation is required and detected
- Timeout handling works if student doesn't press button
- LED provides clear visual feedback for each state
- Robot returns to origin after visiting all desks
- Comprehensive logging shows full mission trace
- Mission summary reports:
  - Total desks visited
  - Papers delivered
  - Empty desks skipped
  - Timeouts encountered

**Mission States & LED Feedback:**
```
State                     LED Color    Duration
---------------------------------------------------
Navigating to desk        Blue         While moving
Checking for person       Yellow       1-2 seconds
Person detected           Green blink  1 second
Waiting for confirmation  Yellow       Until button/timeout
Delivery confirmed        Green        2 seconds
Timeout (no confirmation) Red          2 seconds
No person detected        Off          Move to next desk
Mission complete          Green blink  3x
```

**Logging Format:**
```
[DELIVERY] Mission started
[DELIVERY] Navigating to Desk 1 (position: 30cm)
[DELIVERY] Arrived at Desk 1
[DELIVERY] Person detected at Desk 1
[DELIVERY] Paper delivered, waiting for confirmation...
[DELIVERY] Confirmation received from Desk 1
[DELIVERY] Navigating to Desk 2 (position: 60cm)
[DELIVERY] Arrived at Desk 2
[DELIVERY] No person detected at Desk 2, skipping
...
[DELIVERY] Returning to origin
[DELIVERY] Mission complete
[DELIVERY] Summary: 4 desks visited, 3 papers delivered, 1 skipped, 0 timeouts
```

**Error Handling:**
- Obstacle encountered during navigation → Use existing avoidance
- Person detection fails → Log error, prompt user, skip or retry
- Button malfunction → Timeout after 30s, allow manual override
- Camera failure → Log error, fall back to delivering to all desks

**Design Considerations:**
- **Stateful execution:** Track which desk is current, delivery status
- **Robust to interruption:** Log progress, could potentially resume
- **User-friendly:** Clear feedback via LEDs and logs
- **Flexible:** Easy to adjust timeouts, desk list, behavior

**Integration Points:**
- Uses `Drive` for navigation
- Uses `PersonDetector` for occupancy detection
- Uses `Button` for confirmation
- Uses `LEDController` for feedback
- Loads configuration from `row_config.json`
- Uses obstacle avoidance from main.py

**Test Scenarios:**
```
Scenario 1: All desks occupied, all confirm
  Expected: 4/4 papers delivered, 0 skipped, 0 timeouts

Scenario 2: Desks 1,3 occupied, Desks 2,4 empty
  Expected: 2/4 papers delivered, 2 skipped, 0 timeouts

Scenario 3: Desk 2 occupied but student doesn't press button
  Expected: 0/1 papers delivered, 0 skipped, 1 timeout

Scenario 4: Obstacle placed in path
  Expected: Avoidance maneuver, continue to next desk

Scenario 5: Desk 1 occupied, confirm; Desk 2 empty; Desk 3 occupied, timeout
  Expected: 1/3 delivered, 1 skipped, 1 timeout
```

**Success Metrics:**
- Mission completion rate: 100% (completes even with errors)
- Delivery accuracy: > 95% (correct detection of occupied desks)
- Button detection reliability: > 99%
- Navigation accuracy: < 5cm positioning error at desks
