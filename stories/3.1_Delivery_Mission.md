# Story 3.1: Paper Delivery Mission

**Epic:** 3 - Integration & Missions

**Description:**
Implement the complete delivery mission that integrates desk-centric polling, navigation, and button confirmation. The robot will **first scan all desks** to identify which are occupied, then navigate only to those desks to deliver papers and wait for student confirmation.

This optimized approach saves time by avoiding navigation to empty desks.

This is the first complete end-to-end mission that brings together all Phase 1 and Phase 2 components.

**Dependencies:**
- ✅ Story 1.1: Row configuration
- ✅ Story 1.2: Linear movement
- ✅ Story 1.3: Precise turns
- ✅ Story 1.4: Row traversal
- ✅ Story 1.5: Obstacle avoidance
- Story 2.1: Person detection
- Story 2.2: Desk-centric polling (generic scanner)
- Story 2.3: Button integration

**Tasks:**
1. Create a new module: `yahoo/mission/delivery.py`
2. Implement `DeliveryMission` class with:
   - `execute()` - Main mission entry point
   - `visit_desk(desk_id)` - Handle delivery at a single desk
   - Integration with all required subsystems
3. Mission workflow:
   - Start at origin
   - Load desk configuration
   - **Phase 1: Scan for occupied desks**
     - Use desk-centric polling to scan all desks
     - Run person detection at each desk
     - Build delivery queue (list of occupied desk IDs)
     - Log: "Found students at Desks: [1, 2, 4]"
     - If no desks occupied: End mission early
   - **Phase 2: Navigate and deliver**
     - For each desk in delivery queue:
       - Navigate to desk position
       - Deliver paper (mechanical action or prompt)
       - Set LED to yellow (waiting for confirmation)
       - Wait for button press (30 second timeout)
       - If button pressed:
         - Set LED to green (success)
         - Log successful delivery
       - If timeout:
         - Set LED to red (timeout)
         - Log timeout
   - Navigate back to origin
   - Report delivery summary
4. Add comprehensive logging:
   - Delivery started/completed
   - Each desk visited and outcome
   - Papers delivered count
   - Any errors or timeouts
5. Create test script: `scripts/run_delivery_mission.py`
6. Test full mission with:
   - All desks occupied
   - Mix of occupied/empty desks
   - Student confirms immediately
   - Student delays confirmation (test timeout)

**Acceptance Criteria:**
- A `yahoo/mission/delivery.py` module exists with `DeliveryMission` class
- A `scripts/run_delivery_mission.py` script successfully runs the full mission
- **Pre-scan polling correctly identifies occupied desks**
- Robot navigates **only** to desks in delivery queue (not all desks)
- Person detection via polling works reliably (> 95% accuracy)
- Papers are delivered only to occupied desks
- Button confirmation is required and detected
- Timeout handling works if student doesn't press button
- LED provides clear visual feedback for each state
- Robot returns to origin after visiting desks in queue
- Comprehensive logging shows full mission trace
- Mission summary reports:
  - Total desks scanned
  - Occupied desks found (delivery queue)
  - Papers delivered
  - Empty desks skipped
  - Timeouts encountered
  - Time saved by not visiting empty desks

**Mission States & LED Feedback:**
```
State                     LED Color    Duration
---------------------------------------------------
Navigating to desk        Blue         While moving
Checking for person       Yellow       1-2 seconds
Person detected           Green blink  1 second
Waiting for confirmation  Yellow       Until button/timeout
Delivery confirmed        Green        2 seconds
Timeout (no confirmation) Red          2 seconds
No person detected        Off          Move to next desk
Mission complete          Green blink  3x
```

**Logging Format:**
```
[DELIVERY] Mission started
[DELIVERY] Phase 1: Scanning for occupied desks...
[DELIVERY] Scanning Desk 1... Person detected
[DELIVERY] Scanning Desk 2... Person detected
[DELIVERY] Scanning Desk 3... Empty
[DELIVERY] Scanning Desk 4... Person detected
[DELIVERY] Scan complete. Delivery queue: [1, 2, 4]
[DELIVERY] Phase 2: Delivering to 3 occupied desks
[DELIVERY] Navigating to Desk 1
[DELIVERY] Arrived at Desk 1
[DELIVERY] Paper delivered, waiting for confirmation...
[DELIVERY] Confirmation received from Desk 1
[DELIVERY] Navigating to Desk 2
[DELIVERY] Arrived at Desk 2
[DELIVERY] Paper delivered, waiting for confirmation...
[DELIVERY] Confirmation received from Desk 2
[DELIVERY] Navigating to Desk 4
[DELIVERY] Arrived at Desk 4
[DELIVERY] Paper delivered, waiting for confirmation...
[DELIVERY] Confirmation received from Desk 4
[DELIVERY] Returning to origin
[DELIVERY] Mission complete
[DELIVERY] Summary: 4 desks scanned, 3 occupied, 3 papers delivered, 1 empty, 0 timeouts
[DELIVERY] Time saved: ~30 seconds (skipped 1 empty desk)
```

**Error Handling:**
- Obstacle encountered during navigation → Use existing avoidance
- Person detection fails → Log error, prompt user, skip or retry
- Button malfunction → Timeout after 30s, allow manual override
- Camera failure → Log error, fall back to delivering to all desks

**Design Considerations:**
- **Stateful execution:** Track which desk is current, delivery status
- **Robust to interruption:** Log progress, could potentially resume
- **User-friendly:** Clear feedback via LEDs and logs
- **Flexible:** Easy to adjust timeouts, desk list, behavior

**Integration Points:**
- Uses `DeskPoller.scan_for_persons()` for pre-scan (Story 2.2)
- Uses `Drive` for navigation (Stories 1.2-1.4)
- Uses `Button` for confirmation (Story 2.3)
- Uses `LEDController` for feedback (existing)
- Loads configuration from `row_config.json` (Story 1.1)
- Uses obstacle avoidance from existing implementation

**Test Scenarios:**
```
Scenario 1: All desks occupied, all confirm
  Scan: [1, 2, 3, 4] occupied
  Expected: Navigate to all 4, deliver 4 papers, 0 timeouts

Scenario 2: Desks 1,3 occupied, Desks 2,4 empty
  Scan: [1, 3] occupied
  Expected: Navigate only to 1,3 (skip 2,4), deliver 2 papers
  Time saved: ~60 seconds

Scenario 3: Desk 2 occupied but student doesn't press button
  Scan: [2] occupied
  Expected: Navigate to 2, timeout, 0 delivered, 1 timeout

Scenario 4: No desks occupied (all students absent)
  Scan: [] empty
  Expected: Mission ends after scan, no navigation, 0 delivered

Scenario 5: Obstacle in path to occupied desk
  Scan: [1, 3] occupied
  Expected: Avoidance during navigation, deliver to both desks

Scenario 6: Mixed outcomes
  Scan: [1, 2, 3, 4] occupied
  Desk 1: confirm, Desk 2: timeout, Desk 3: confirm, Desk 4: confirm
  Expected: 3 delivered, 1 timeout
```

**Success Metrics:**
- Mission completion rate: 100% (completes even with errors)
- Delivery accuracy: > 95% (correct detection of occupied desks)
- Button detection reliability: > 99%
- Navigation accuracy: < 5cm positioning error at desks
