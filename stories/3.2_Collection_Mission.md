# Story 3.2: Paper Collection Mission

**Epic:** 3 - Integration & Missions

**Description:**
Implement the complete collection mission that integrates desk-centric polling, navigation, and paper scanning. The robot will scan all desks for raised hands, navigate to desks in the collection queue, and scan papers as students insert them.

This is the second complete end-to-end mission and completes the MVP functionality.

**Dependencies:**
- ✅ Story 1.1: Row configuration
- ✅ Story 1.2: Linear movement
- ✅ Story 1.3: Precise turns
- ✅ Story 1.4: Row traversal
- ✅ Story 1.5: Obstacle avoidance
- Story 2.2: Desk-centric polling
- Story 2.4: Paper scanning

**Tasks:**
1. Create a new module: `yahoo/mission/collection.py`
2. Implement `CollectionMission` class with:
   - `execute()` - Main mission entry point
   - `poll_for_requests()` - Desk-centric polling scan
   - `collect_from_desk(desk_id)` - Navigate and scan paper at desk
   - Integration with all required subsystems
3. Mission workflow:
   - Start at origin (waiting position)
   - Perform desk-centric polling scan:
     - Turn to face each desk
     - Check for raised hand using gesture detection
     - Build collection queue of desk IDs with raised hands
   - If collection queue is empty:
     - Log "No collection requests"
     - End mission
   - For each desk in collection queue:
     - Navigate to desk position
     - Set LED to yellow (waiting for paper)
     - Wait for paper insertion (paper scanner)
     - Scan and save paper image
     - Set LED to green (scan complete)
     - Log successful collection
   - Navigate back to origin
   - Report collection summary
4. Add comprehensive logging:
   - Polling scan started
   - Each desk scanned and result
   - Collection queue built
   - Each paper collected
   - Collection summary
5. Create test script: `scripts/run_collection_mission.py`
6. Test full mission with:
   - Single desk raises hand
   - Multiple desks raise hands (one at a time during scan)
   - No hands raised
   - Student inserts paper promptly
   - Student delays paper insertion (test timeout)

**Acceptance Criteria:**
- A `yahoo/mission/collection.py` module exists with `CollectionMission` class
- A `scripts/run_collection_mission.py` script successfully runs the full mission
- Desk-centric polling correctly identifies which desks have raised hands
- Robot navigates only to desks in collection queue (doesn't visit all desks)
- Paper scanning workflow completes successfully
- Scanned images are saved with correct desk_id metadata
- LED provides clear visual feedback for each state
- Robot returns to origin after collecting all papers
- Comprehensive logging shows full mission trace
- Mission summary reports:
  - Desks polled
  - Hands detected (collection queue)
  - Papers collected
  - Any timeouts or errors

**Mission States & LED Feedback:**
```
State                     LED Color    Duration
---------------------------------------------------
Polling scan in progress  Blue         While scanning
Hand detected             Green blink  Brief
Navigating to desk        Blue         While moving
Waiting for paper         Yellow       Until paper/timeout
Paper detected            Yellow blink While scanning
Scan complete             Green        2 seconds
Timeout (no paper)        Red          2 seconds
Mission complete          Green blink  3x
```

**Logging Format:**
```
[COLLECTION] Mission started
[COLLECTION] Starting desk-centric polling scan...
[COLLECTION] Scanning Desk 1... No hand detected
[COLLECTION] Scanning Desk 2... Hand detected! Added to queue
[COLLECTION] Scanning Desk 3... No hand detected
[COLLECTION] Scanning Desk 4... Hand detected! Added to queue
[COLLECTION] Polling complete. Collection queue: [2, 4]
[COLLECTION] Navigating to Desk 2
[COLLECTION] Arrived at Desk 2, waiting for paper...
[COLLECTION] Paper detected, scanning...
[COLLECTION] Scan complete: desk_2_20251213_143022.jpg
[COLLECTION] Navigating to Desk 4
[COLLECTION] Arrived at Desk 4, waiting for paper...
[COLLECTION] Paper detected, scanning...
[COLLECTION] Scan complete: desk_4_20251213_143045.jpg
[COLLECTION] Returning to origin
[COLLECTION] Mission complete
[COLLECTION] Summary: 4 desks polled, 2 hands detected, 2 papers collected, 0 timeouts
```

**Student Protocol:**
Students must understand the collection workflow:
1. Wait for polling scan (robot will turn to face your desk)
2. Raise hand when robot faces your desk
3. Keep hand raised until robot blinks green (detected)
4. Wait for robot to arrive at your desk
5. When LED turns yellow, insert paper into collection slot
6. Wait for green LED (scan complete)

**Error Handling:**
- No hands detected during polling → End mission gracefully
- Hand detected but student not there when robot arrives → Timeout, log error
- Paper not inserted within timeout → Log timeout, move to next desk
- Scanner fails → Log error, attempt retry, skip if fails again
- Obstacle during navigation → Use existing avoidance

**Design Considerations:**
- **Efficient routing:** Visit desks in collection queue in order along row
- **Student feedback:** Clear LED signals guide student actions
- **Timeout handling:** Don't wait forever if student has issue
- **Data integrity:** Link scanned papers to correct desk IDs
- **Logging:** Full trace for debugging and verification

**Integration Points:**
- Uses `DeskPoller` for polling scan
- Uses `Drive` for navigation
- Uses `PaperScanner` for scanning
- Uses `LEDController` for feedback
- Loads configuration from `row_config.json`
- Uses obstacle avoidance from main.py

**Test Scenarios:**
```
Scenario 1: Two desks raise hands (Desk 1, Desk 3), both insert papers
  Expected: Queue [1,3], 2 papers collected, 0 timeouts

Scenario 2: No desks raise hands
  Expected: Queue empty, mission ends, 0 papers collected

Scenario 3: Desk 2 raises hand but doesn't insert paper
  Expected: Queue [2], 0 papers collected, 1 timeout

Scenario 4: All 4 desks raise hands (one at a time during scan), all insert papers
  Expected: Queue [1,2,3,4], 4 papers collected, 0 timeouts

Scenario 5: Desk 3 raises hand, obstacle in path
  Expected: Avoidance maneuver, arrive at Desk 3, paper collected
```

**Success Metrics:**
- Polling accuracy: > 95% (correct desk identified when hand raised)
- Collection success rate: > 90% (paper scanned when student present)
- No cross-desk confusion: 100% (never collect from wrong desk)
- Mission completion: 100% (completes even with errors)

**Queue Management:**
- Queue is ordered by desk ID (natural order along row)
- Could optimize to minimize travel distance
- For MVP: Simple in-order traversal is sufficient
