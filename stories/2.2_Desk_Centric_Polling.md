# Story 2.2: Desk-Centric Polling (Generic Scanner)

**Epic:** 2 - Perception & Sensing

**Description:**
Implement the desk-centric polling strategy as a **generic scanning system** that can detect both person presence and raised hands. The robot will systematically turn to face each desk and run different detectors based on the mission phase.

This polling system will be used in BOTH delivery and collection phases for maximum efficiency.

See `docs/DESK_CENTRIC_POLLING.md` for detailed strategy documentation.

**Tasks:**
1. Add `scan_angle` property to desk configuration (from Story 1.1)
   - ✅ Already included in row_config.json
2. Create a new module: `yahoo/mission/polling.py`
3. Implement `DeskPoller` class with **generic scanning**:
   - `scan_all_desks(detector)` - Main polling routine with any detector
   - `scan_for_persons()` - Scan for person presence (delivery phase)
   - `scan_for_raised_hands()` - Scan for raised hands (collection phase)
   - `scan_desk(desk_id, detector)` - Turn to desk, run detector
   - Returns list of desk IDs that match detection criteria
4. Scanning routine should:
   - Start from origin/polling position
   - Reset to known heading (0°)
   - For each desk:
     - Turn to desk's scan_angle
     - Wait for camera stabilization (0.5s)
     - Capture frame and run detector (person or gesture)
     - If detected: add to queue, log detection
     - LED feedback (green blink)
   - Return to original heading
   - Return queue list
5. Experimentally determine optimal scan angles:
   - Set up test desks in a row
   - Have person sit at each desk (test person detection)
   - Have person raise hand at each desk (test gesture detection)
   - Test different robot positions and angles
   - Record angles that reliably center each desk in frame
   - Update configuration with working angles
6. Create test scripts:
   - `tests/test_polling_persons.py` - Test person detection scanning
   - `tests/test_polling_hands.py` - Test hand-raise detection scanning
7. Add LED feedback for detections (green blink)

**Acceptance Criteria:**
- A `yahoo/mission/polling.py` module exists with `DeskPoller` class
- Configuration includes scan angles for each desk (✅ already done in Story 1.1)
- Robot can systematically scan all desks in sequence
- **Generic scanning works with different detectors:**
  - `scan_for_persons()` returns list of occupied desks
  - `scan_for_raised_hands()` returns list of desks with raised hands
- Scan of 4 desks completes in < 30 seconds
- System correctly identifies which desk triggered detection (no ambiguity)
- Test scripts demonstrate:
  - Person detection: Detects occupied desks, skips empty desks
  - Hand detection: Detects raised hands, ignores sitting students
  - Multiple detections work correctly (one at a time during scan)
  - No false positives or cross-desk confusion
- LED provides visual feedback when detection occurs

**Design Considerations:**
- **Student protocol:** Only one student raises hand at a time
- **Timing:** Brief pause after turn for camera to stabilize
- **Robustness:** If gesture detection fails, log and continue to next desk
- **Queue management:** Store desk IDs in order detected
- **Visual feedback:** LED blink confirms detection to student

**Experimental Testing:**
Create a test checklist for finding optimal angles:
```
[ ] Set up 4 desks in a row (30cm spacing)
[ ] Position robot at origin
[ ] For each desk:
    [ ] Have student raise hand
    [ ] Test robot turning to different angles (80-100°)
    [ ] Record angle where desk is centered in camera view
    [ ] Verify gesture detection works reliably
    [ ] Document working angle in config
[ ] Test full sequence of all desks
[ ] Verify no cross-detection (wrong desk)
```

**Integration Points:**
- Uses `PersonDetector` from `yahoo/sense/person_detector.py` (Story 2.1)
- Uses `GestureDetector` from `yahoo/sense/gesture.py` (existing)
- Uses `Drive.turn_degrees()` for positioning
- Uses `LEDController` for feedback
- Loads desk configuration from Story 1.1 (✅ complete)
- Will be called by:
  - **Delivery mission (Story 3.1)** - scan for persons
  - **Collection mission (Story 3.2)** - scan for raised hands

**Success Metrics:**
- Detection accuracy: > 95% (detects raised hand when pointed at correct desk)
- False positive rate: < 5% (doesn't detect hands at other desks)
- No cross-desk confusion (always identifies correct desk)
