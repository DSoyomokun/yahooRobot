# Story 2.4: Paper Scanning Integration

**Epic:** 2 - Perception & Sensing

**Description:**
Integrate the existing scanner module (`yahoo/mission/scanner/`) into the collection workflow. When a student inserts their completed paper into the robot's collection slot, the Pi Camera will capture an image and log the scan event.

**Tasks:**
1. Review existing scanner module:
   - Read `yahoo/mission/scanner/scanner.py`
   - Read `yahoo/mission/scanner/bubble_detector.py`
   - Understand how paper detection and capture works
2. Create a wrapper module: `yahoo/mission/paper_scanner.py`
3. Implement `PaperScanner` class with:
   - `wait_for_paper(timeout=30)` - Wait for paper insertion (brightness detection)
   - `scan_paper(desk_id)` - Capture image, log scan event
   - Integration with existing scanner module
   - Simulation mode support (mock scan)
4. Test scanner workflow:
   - Paper inserted â†’ detected via brightness change
   - Image captured and saved
   - Scan logged to database/CSV
   - Student receives feedback (LED)
5. Create test script: `tests/test_paper_scanner.py`
6. Document the scanning process in code comments

**Acceptance Criteria:**
- A `yahoo/mission/paper_scanner.py` module exists with `PaperScanner` class
- Paper insertion is detected using existing brightness detection
- Image is captured and saved with desk_id in filename/metadata
- Scan event is logged (timestamp, desk_id, image_path)
- LED provides feedback when scan complete (green)
- Simulation mode allows mock scanning for testing
- Test script demonstrates:
  - Paper detection works
  - Image capture succeeds
  - Logging functions correctly
  - Timeout handling if no paper inserted

**Technical Integration:**

**Existing Scanner Components:**
```python
# From yahoo/mission/scanner/scanner.py
from yahoo.mission.scanner.scanner import Scanner
from yahoo.mission.scanner.bubble_detector import BubbleDetector

# Typical usage pattern (to be wrapped)
scanner = Scanner()
scanner.start()
# ... detection and capture logic ...
```

**Wrapper Implementation:**
```python
class PaperScanner:
    def __init__(self, robot=None, simulate=False):
        self.robot = robot
        self.simulate = simulate

        if not simulate:
            from yahoo.mission.scanner.scanner import Scanner
            self.scanner = Scanner()

    def wait_for_paper(self, timeout=30):
        """Wait for paper insertion using brightness detection"""
        # Use existing scanner's detection logic

    def scan_paper(self, desk_id):
        """Capture and log paper scan"""
        # Use existing scanner's capture logic
        # Add desk_id to metadata
        # Return image path and success status
```

**Design Considerations:**
- **Reuse existing code:** Don't rewrite scanner, just wrap it
- **Add desk context:** Link scanned images to desk IDs
- **Student feedback:** LED shows scan successful
- **Error handling:** Timeout if paper not inserted
- **Logging:** Track which papers were collected from which desks

**Scanner Module Review Checklist:**
```
[ ] Read scanner.py - understand main Scanner class
[ ] Read bubble_detector.py - understand detection logic
[ ] Check camera initialization (Pi Camera vs USB)
[ ] Understand brightness-based paper detection
[ ] Review image capture and storage logic
[ ] Check existing logging/database code
[ ] Identify simulation mode support
```

**Integration Points:**
- Uses existing `yahoo/mission/scanner/` module
- Uses `LEDController` for feedback
- Called by collection mission (Story 3.2)
- Logs to same database/CSV as scanner module
- Works with Pi Camera (CSI camera)

**Success Criteria:**
- Paper detection rate: > 95% (reliably detects inserted paper)
- False positive rate: < 5% (doesn't trigger without paper)
- Image quality: Clear, in-focus images of scanned papers
- Logging completeness: All scans recorded with desk_id and timestamp

**Future Enhancements** (not in MVP):
- OCR to read student names
- Automatic grading using bubble detection
- Link scans to student records
